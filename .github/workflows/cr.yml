name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write   # to leave the summary comment

    steps:
    # 1Ô∏è‚É£  Check out the repo (full history for git diff)
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # 2Ô∏è‚É£  Minimal Python setup (cache pip to speed repeats)
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: "pip"

    # 3Ô∏è‚É£  Clone the tool and install its pinned deps
    - name: Install AI Code Review tool
      run: |
        git clone --depth 1 https://github.com/Nayjest/github-ai-code-review reviewer
        python -m pip install --upgrade pip
        pip install -r reviewer/requirements.txt

    # 4Ô∏è‚É£  Build a patch of the PR versus its base branch
    - name: Generate patch file
      shell: bash
      run: |
        git fetch origin "${{ github.base_ref }}"
        mkdir -p reviewer/storage/out
        git diff "origin/${{ github.base_ref }}"...HEAD > reviewer/storage/pr.patch
        echo "Patch size: $(wc -l reviewer/storage/pr.patch) lines"

    # 5Ô∏è‚É£  Run the reviewer (writes reports to reviewer/out/)
    - name: Run AI code review
      env:
        LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        LLM_API_TYPE: openai
        MODEL: "gpt-4.1"
      run: |
        cd reviewer; python cr.py pr.patch

    # 6Ô∏è‚É£  Upload full results so they‚Äôre downloadable
    - uses: actions/upload-artifact@v4
      with:
        name: ai-code-review-results
        path: reviewer/storage/out/
    # 7Ô∏è‚É£  Post a readable summary to the pull-request
    - name: Comment on PR with review
      uses: actions/github-script@v7
      env:
        MAX_COMMENT_BYTES: "65000"
      with:
        script: |
          const fs   = require('fs');
          const core = require('@actions/core');

          const DIR = 'reviewer/storage/out';        // <-- make sure this matches your artifact path
          if (!fs.existsSync(DIR)) {
            core.info('No review output produced.');
            return;
          }

          let body = '## ü§ñ GPT-4 Code Review\n\n';
          for (const file of fs.readdirSync(DIR)) {
            const title = file.replace('.txt', '');
            let text    = fs.readFileSync(`${DIR}/${file}`, 'utf8');
            if (text.length > +process.env.MAX_COMMENT_BYTES) {
              text = text.slice(0, +process.env.MAX_COMMENT_BYTES) + '\n‚Ä¶(truncated)‚Ä¶';
            }
            body += `### ${title}\n\`\`\`\n${text}\n\`\`\`\n`;
          }

          // üîë include owner & repo (or just spread context.issue)
          await github.rest.issues.createComment({
            owner:   context.repo.owner,
            repo:    context.repo.repo,
            issue_number: context.issue.number,
            body
          });
